{% extends 'base.html' %}

{% block title %}Order History - Tiffin Service{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="mb-2">
                        <i class="fas fa-receipt text-primary me-3"></i> 
                        {% if user.user_type == 'customer' %}My Orders{% else %}Received Orders{% endif %}
                    </h1>
                    <p class="text-muted mb-0">
                        {% if user.user_type == 'customer' %}Track your recent orders{% else %}Manage incoming orders{% endif %}
                    </p>
                </div>
                <div class="text-end">
                    <span class="badge bg-primary fs-6">{{ orders|length }} Orders</span>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        {% for order in orders %}
        <div class="col-12 mb-4">
            <div class="card border-0 shadow-sm hover-lift">
                <div class="card-body p-0">
                    <div class="row g-0">
                        <!-- Left Section - Order Info -->
                        <div class="col-lg-8">
                            <div class="p-4">
                                <div class="d-flex justify-content-between align-items-start mb-3">
                                    <div>
                                        <h5 class="mb-1 text-primary">Order #{{ order.order_number }}</h5>
                                        <div class="d-flex align-items-center text-muted small">
                                            <i class="far fa-clock me-2"></i>
                                            {{ order.created_at|date:"M d, Y - H:i" }}
                                        </div>
                                    </div>
                                    <div class="text-end">
                                        <span class="badge 
                                            {% if order.status == 'pending' %}bg-warning text-dark
                                            {% elif order.status == 'confirmed' %}bg-info
                                            {% elif order.status == 'preparing' %}bg-primary
                                            {% elif order.status == 'ready' %}bg-success
                                            {% elif order.status == 'delivered' %}bg-success
                                            {% else %}bg-danger
                                            {% endif %} px-3 py-2">
                                            <i class="fas fa-circle me-2" style="font-size: 8px;"></i>
                                            {{ order.get_status_display }}
                                        </span>
                                    </div>
                                </div>

                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="text-muted small d-block">Customer/Provider</label>
                                            <span class="fw-semibold">
                                                {% if user.user_type == 'customer' %}
                                                    <i class="fas fa-store me-2 text-primary"></i>{{ order.provider.business_name }}
                                                {% else %}
                                                    <i class="fas fa-user me-2 text-primary"></i>{{ order.customer.username }}
                                                {% endif %}
                                            </span>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="text-muted small d-block">Delivery</label>
                                            <span class="fw-semibold">
                                                <i class="far fa-calendar me-2 text-primary"></i>{{ order.delivery_date }}
                                                <i class="far fa-clock ms-2 me-2 text-primary"></i>{{ order.delivery_time }}
                                            </span>
                                        </div>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label class="text-muted small d-block">Delivery Address</label>
                                    <div class="d-flex align-items-start">
                                        <i class="fas fa-map-marker-alt text-primary me-2 mt-1"></i>
                                        <span class="text-secondary">{{ order.delivery_address }}</span>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label class="text-muted small d-block">Order Items</label>
                                    <div class="bg-light rounded p-3">
                                        {% for item in order.items.all %}
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <div>
                                                <span class="fw-semibold">{{ item.quantity }}x</span>
                                                <span class="ms-2">{{ item.tiffin_service.name }}</span>
                                            </div>
                                            <span class="text-primary fw-semibold">‚Çπ{{ item.total_price }}</span>
                                        </div>
                                        {% endfor %}
                                    </div>
                                </div>

                                {% if order.special_instructions %}
                                <div class="mb-3">
                                    <label class="text-muted small d-block">Special Instructions</label>
                                    <div class="bg-warning bg-opacity-10 border-start border-3 border-warning ps-3 py-2">
                                        <small class="text-secondary">{{ order.special_instructions }}</small>
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Right Section - Price & Actions -->
                        <div class="col-lg-4">
                            <div class="p-4 bg-light border-start">
                                <div class="text-center mb-4">
                                    <div class="text-muted small mb-1">Total Amount</div>
                                    <h3 class="text-primary mb-0">‚Çπ{{ order.total_amount }}</h3>
                                </div>

                                <div class="d-grid gap-2">
                                    <a href="{% url 'order_detail' order.id %}" class="btn btn-outline-primary">
                                        <i class="fas fa-eye me-2"></i>View Details
                                    </a>
                                    
                                    {% if user.user_type == 'provider' and order.status != 'delivered' and order.status != 'cancelled' %}
                                    <div class="mt-3">
                                        <label class="text-muted small d-block mb-2">Update Status</label>
                                        <select class="form-select" onchange="updateOrderStatus('{{ order.id }}', this.value)">
                                            <option value="">Choose Status</option>
                                            {% if order.status == 'pending' %}
                                                <option value="confirmed">‚úì Confirm Order</option>
                                                <option value="cancelled">‚úó Cancel Order</option>
                                            {% elif order.status == 'confirmed' %}
                                                <option value="preparing">üç≥ Start Preparing</option>
                                            {% elif order.status == 'preparing' %}
                                                <option value="ready">üì¶ Mark Ready</option>
                                            {% elif order.status == 'ready' %}
                                                <option value="delivered">üöö Mark Delivered</option>
                                            {% endif %}
                                        </select>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% empty %}
        <div class="col-12">
            <div class="text-center py-5">
                <div class="mb-4">
                    <i class="fas fa-inbox fa-4x text-muted opacity-50"></i>
                </div>
                <h3 class="text-muted mb-3">No orders found</h3>
                <p class="text-muted mb-4">
                    {% if user.user_type == 'customer' %}
                        You haven't placed any orders yet. Start browsing our delicious tiffins!
                    {% else %}
                        You haven't received any orders yet. Make sure your tiffins are active and attractive!
                    {% endif %}
                </p>
                {% if user.user_type == 'customer' %}
                    <a href="{% url 'tiffin_list' %}" class="btn btn-primary btn-lg">
                        <i class="fas fa-utensils me-2"></i>Browse Tiffins
                    </a>
                {% else %}
                    <a href="{% url 'add_tiffin' %}" class="btn btn-primary btn-lg">
                        <i class="fas fa-plus me-2"></i>Add Tiffin Service
                    </a>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<style>
.hover-lift {
    transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
}
.hover-lift:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.1) !important;
}
</style>
{% endblock %}

{% block scripts %}
{% csrf_token %}
<script>
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function updateOrderStatus(orderId, newStatus) {
    if (!newStatus) return;
    
    fetch(`/orders/update-status/${orderId}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: `status=${newStatus}`
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            Toastify({
                text: "Order status updated successfully!",
                duration: 3000,
                gravity: "top",
                position: "right",
                backgroundColor: "#20C997",
                stopOnFocus: true
            }).showToast();
            setTimeout(() => location.reload(), 1500);
        } else {
            Toastify({
                text: data.error || "Error updating status",
                duration: 3000,
                gravity: "top",
                position: "right",
                backgroundColor: "#EF476F",
                stopOnFocus: true
            }).showToast();
        }
    })
    .catch(error => {
        console.error('Error:', error);
        Toastify({
            text: "Error updating status. Please try again.",
            duration: 3000,
            gravity: "top",
            position: "right",
            backgroundColor: "#EF476F",
            stopOnFocus: true
        }).showToast();
    });
}
</script>
{% endblock %}
